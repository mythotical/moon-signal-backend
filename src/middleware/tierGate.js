const TIER_LEVELS = { BASIC: 1, PRO: 2, PROPLUS: 3 };\n\nfunction getTierLevel(tier) {\n  const t = String(tier || "").toUpperCase();\n  if (t === "PRO+") return TIER_LEVELS.PROPLUS;\n  if (t === "PROPLUS") return TIER_LEVELS.PROPLUS;\n  if (t === "PRO") return TIER_LEVELS.PRO;\n  return TIER_LEVELS.BASIC;\n}\n\n// Extract license key from request\nfunction extractLicenseKey(req) {\n  return req.headers["x-ms-key"] || req.query.key || "";\n}\n\n// Middleware to require license and specific tier\nfunction requireTier(requiredTier = "BASIC") {\n  return async (req, res, next) => {\n    try {\n      const key = extractLicenseKey(req);\n      if (!key) {\n        return res.status(401).json({ ok: false, error: "missing_license_key" });\n      }\n\n      // Validate key with Keygen\n      const accountId = process.env.KEYGEN_ACCOUNT_ID;\n      const token = process.env.KEYGEN_TOKEN;\n      if (!accountId || !token) {\n        return res.status(500).json({ ok: false, error: "backend_config_error" });\n      }\n\n      const validateRes = await fetch(\n        `https://api.keygen.sh/v1/accounts/${accountId}/licenses/actions/validate-key`,\n        {\n          method: "POST",\n          headers: {\n            Authorization: `Bearer ${token}`,\n            "Content-Type": "application/vnd.api+json",\n            Accept: "application/vnd.api+json",\n          },\n          body: JSON.stringify({ meta: { key: String(key).trim() } }),\n        }\n      );\n\n      const json = await validateRes.json().catch(() => ({}));\n      if (!validateRes.ok || json?.meta?.valid !== true) {\n        return res.status(403).json({ ok: false, error: "invalid_or_expired_key" });\n      }\n\n      // Extract tier from metadata\n      const tierFromMeta = json?.data?.attributes?.metadata?.tier || "BASIC";\n      const userTierLevel = getTierLevel(tierFromMeta);\n      const requiredLevel = getTierLevel(requiredTier);\n\n      if (userTierLevel < requiredLevel) {\n        return res.status(402).json({\n          ok: false,\n          error: "upgrade_required",\n          userTier: tierFromMeta,\n          requiredTier: requiredTier,\n        });\n      }\n\n      // Attach to request for route handlers\n      req.license = {\n        key,\n        tier: tierFromMeta,\n        valid: true,\n      };\n\n      next();\n    } catch (err) {\n      console.error("Tier gate error:", err.message);\n      return res.status(500).json({ ok: false, error: "auth_error" });\n    }\n  };\n}\n\nmodule.exports = { requireTier, extractLicenseKey, getTierLevel, TIER_LEVELS };